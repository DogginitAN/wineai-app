<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>wine.ai</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@0,400;0,600;0,700;1,400&family=Inter:wght@300;400;500;600&display=swap" rel="stylesheet">
<style>
*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

:root {
  --bg: #0d0d0d;
  --bg-raised: #161616;
  --bg-card: #1a1a1a;
  --bg-card-hover: #1f1f1f;
  --gold: #c9a96e;
  --gold-dim: rgba(201,169,110,0.5);
  --gold-glow: rgba(201,169,110,0.08);
  --cream: #f2ece0;
  --cream-dim: rgba(242,236,224,0.55);
  --cream-muted: rgba(242,236,224,0.3);
  --wine: #8b2635;
  --wine-soft: rgba(139,38,53,0.25);
  --border: rgba(242,236,224,0.08);
  --border-light: rgba(242,236,224,0.12);
  --serif: 'Playfair Display', Georgia, 'Times New Roman', serif;
  --sans: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
  --radius: 2px;
}

[data-theme="light"] {
  --bg: #f4f1eb;
  --bg-raised: #ece8e0;
  --bg-card: #ffffff;
  --bg-card-hover: #faf8f5;
  --gold: #8b6914;
  --gold-dim: rgba(139,105,20,0.45);
  --gold-glow: rgba(139,105,20,0.06);
  --cream: #1a1a1a;
  --cream-dim: rgba(26,26,26,0.6);
  --cream-muted: rgba(26,26,26,0.35);
  --wine: #8b2635;
  --wine-soft: rgba(139,38,53,0.12);
  --border: rgba(26,26,26,0.08);
  --border-light: rgba(26,26,26,0.15);
}

html { font-size: 16px; -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale; }

body {
  font-family: var(--sans);
  background: var(--bg);
  color: var(--cream);
  min-height: 100vh;
  overflow-x: hidden;
}

::selection { background: var(--gold); color: var(--bg); }
::-webkit-scrollbar { width: 4px; }
::-webkit-scrollbar-track { background: transparent; }
::-webkit-scrollbar-thumb { background: rgba(201,169,110,0.2); border-radius: 2px; }
[data-theme="light"] ::-webkit-scrollbar-thumb { background: rgba(26,26,26,0.15); }

/* ── Theme toggle ── */
.theme-toggle {
  position: absolute;
  top: 1.25rem;
  right: 1.25rem;
  background: none;
  border: 1px solid var(--border-light);
  border-radius: 50%;
  width: 32px;
  height: 32px;
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  color: var(--cream-muted);
  transition: color 0.25s, border-color 0.25s;
  z-index: 10;
}

.theme-toggle:hover {
  color: var(--gold);
  border-color: var(--gold);
}

.theme-toggle .icon-sun,
.theme-toggle .icon-moon { width: 15px; height: 15px; }

.theme-toggle .icon-sun { display: none; }
.theme-toggle .icon-moon { display: block; }

[data-theme="light"] .theme-toggle .icon-sun { display: block; }
[data-theme="light"] .theme-toggle .icon-moon { display: none; }

[data-theme="light"] header::before {
  background: radial-gradient(ellipse at 50% 0%, rgba(139,105,20,0.04) 0%, transparent 70%);
}

[data-theme="light"] .legs-decoration { opacity: 0.04; }

/* ── Hero / Header ── */
header {
  position: relative;
  padding: 3rem 1.5rem 2rem;
  text-align: center;
  border-bottom: 1px solid var(--border);
}

header::before {
  content: '';
  position: absolute;
  top: 0; left: 0; right: 0;
  height: 100%;
  background: radial-gradient(ellipse at 50% 0%, rgba(201,169,110,0.04) 0%, transparent 70%);
  pointer-events: none;
}

.brand {
  margin-bottom: 2rem;
  position: relative;
}

.brand h1 {
  font-family: var(--serif);
  font-size: 2.8rem;
  font-weight: 400;
  color: var(--cream);
  letter-spacing: 0.04em;
  line-height: 1;
  margin-bottom: 0.5rem;
}

.brand h1 .dot { color: var(--gold); }

.tagline {
  font-family: var(--sans);
  font-size: 0.7rem;
  font-weight: 300;
  text-transform: uppercase;
  letter-spacing: 0.25em;
  color: var(--cream-muted);
}

.stats-line {
  font-size: 0.65rem;
  color: var(--cream-muted);
  letter-spacing: 0.15em;
  text-transform: uppercase;
  margin-top: 0.75rem;
}

/* ── Wine legs SVG decoration ── */
.legs-decoration {
  position: absolute;
  top: 0;
  left: 50%;
  transform: translateX(-50%);
  width: 200px;
  height: 100%;
  opacity: 0.03;
  pointer-events: none;
}

/* ── Search ── */
.search-section {
  max-width: 560px;
  margin: 0 auto;
  position: relative;
}

#search {
  width: 100%;
  padding: 1rem 1.25rem;
  padding-right: 2.5rem;
  font-family: var(--serif);
  font-size: 1rem;
  font-style: italic;
  font-weight: 400;
  color: var(--cream);
  background: transparent;
  border: none;
  border-bottom: 1px solid var(--border-light);
  outline: none;
  transition: border-color 0.3s;
  letter-spacing: 0.01em;
}

#search::placeholder {
  color: var(--cream-muted);
  font-style: italic;
}

#search:focus {
  border-bottom-color: var(--gold);
}

.search-clear {
  position: absolute;
  right: 0;
  top: 50%;
  transform: translateY(-50%);
  background: none;
  border: none;
  color: var(--cream-muted);
  font-size: 1.2rem;
  cursor: pointer;
  padding: 0.5rem;
  line-height: 1;
  display: none;
  transition: color 0.2s;
}

.search-clear:hover { color: var(--gold); }
.search-clear.visible { display: block; }

/* ── Filters ── */
.filters-wrap {
  border-bottom: 1px solid var(--border);
}

.filters {
  display: flex;
  gap: 0;
  max-width: 560px;
  margin: 0 auto;
  overflow-x: auto;
  scrollbar-width: none;
}
.filters::-webkit-scrollbar { display: none; }

.chip {
  flex-shrink: 0;
  padding: 0.9rem 1.1rem;
  font-family: var(--sans);
  font-size: 0.65rem;
  font-weight: 400;
  text-transform: uppercase;
  letter-spacing: 0.18em;
  color: var(--cream-muted);
  background: transparent;
  border: none;
  border-bottom: 2px solid transparent;
  cursor: pointer;
  transition: all 0.25s;
  white-space: nowrap;
}

.chip:hover {
  color: var(--cream);
}

.chip.active {
  color: var(--gold);
  border-bottom-color: var(--gold);
}

/* ── Main ── */
main {
  max-width: 560px;
  margin: 0 auto;
  padding: 1.5rem 1.5rem 4rem;
}

.results-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 1.75rem;
  padding-bottom: 0.75rem;
  border-bottom: 1px solid var(--border);
}

.results-count {
  font-size: 0.6rem;
  color: var(--cream-muted);
  text-transform: uppercase;
  letter-spacing: 0.2em;
}

.sort-btn {
  font-family: var(--sans);
  font-size: 0.6rem;
  text-transform: uppercase;
  letter-spacing: 0.15em;
  color: var(--cream-muted);
  background: none;
  border: none;
  cursor: pointer;
  transition: color 0.2s;
}

.sort-btn:hover { color: var(--gold); }

/* ── Wine Cards ── */
.wine-card {
  padding: 1.5rem 0;
  border-bottom: 1px solid var(--border);
  transition: background 0.2s;
}

.wine-card:first-child { padding-top: 0; }

.card-top {
  display: flex;
  justify-content: space-between;
  align-items: flex-start;
  gap: 1rem;
}

.card-info { flex: 1; min-width: 0; }

.wine-name {
  font-family: var(--serif);
  font-size: 1.15rem;
  font-weight: 400;
  line-height: 1.35;
  color: var(--cream);
  margin-bottom: 0.35rem;
  letter-spacing: 0.01em;
}

.wine-meta {
  font-size: 0.72rem;
  color: var(--cream-dim);
  line-height: 1.5;
  font-weight: 300;
  letter-spacing: 0.02em;
}

.wine-meta span { white-space: nowrap; }
.meta-sep { margin: 0 0.4rem; opacity: 0.3; color: var(--gold); }

/* ── Match score ── */
.match-badge {
  flex-shrink: 0;
  text-align: right;
}

.match-pct {
  font-family: var(--serif);
  font-size: 1.6rem;
  font-weight: 400;
  color: var(--gold);
  line-height: 1;
}

.match-label {
  font-family: var(--sans);
  font-size: 0.5rem;
  color: var(--gold-dim);
  text-transform: uppercase;
  letter-spacing: 0.15em;
}

/* ── Tags ── */
.card-details {
  display: flex;
  align-items: baseline;
  gap: 1.25rem;
  margin-top: 0.75rem;
  flex-wrap: wrap;
}

.detail-item {
  font-size: 0.62rem;
  text-transform: uppercase;
  letter-spacing: 0.12em;
  color: var(--cream-muted);
  font-weight: 400;
}

.detail-item.price {
  color: var(--gold);
  font-weight: 500;
  font-size: 0.7rem;
  letter-spacing: 0.05em;
}

.detail-item.store { color: var(--cream-dim); }

.detail-item.also {
  font-style: italic;
  text-transform: none;
  letter-spacing: 0.02em;
  color: var(--cream-muted);
  font-size: 0.65rem;
}

/* ── Reason / Notes ── */
.card-reason {
  font-family: var(--serif);
  font-size: 0.8rem;
  font-style: italic;
  color: var(--cream-dim);
  margin-top: 0.65rem;
  font-weight: 400;
}

.notes-toggle {
  font-family: var(--sans);
  font-size: 0.6rem;
  text-transform: uppercase;
  letter-spacing: 0.15em;
  color: var(--gold-dim);
  background: none;
  border: none;
  cursor: pointer;
  margin-top: 0.65rem;
  padding: 0;
  transition: color 0.2s;
}

.notes-toggle:hover { color: var(--gold); }

.card-notes {
  font-size: 0.78rem;
  color: var(--cream-dim);
  line-height: 1.7;
  margin-top: 0.5rem;
  display: none;
  font-weight: 300;
  max-width: 480px;
}

.card-notes.open { display: block; }

/* ── Find Similar button ── */
.btn-similar {
  font-family: var(--sans);
  font-size: 0.58rem;
  text-transform: uppercase;
  letter-spacing: 0.12em;
  color: var(--cream-muted);
  background: none;
  border: 1px solid var(--border-light);
  border-radius: var(--radius);
  padding: 0.3rem 0.6rem;
  cursor: pointer;
  transition: all 0.2s;
  margin-left: 1rem;
}

.btn-similar:hover {
  color: var(--gold);
  border-color: var(--gold);
}

/* ── Similar-mode header ── */
.similar-header {
  margin-bottom: 1.5rem;
}

.similar-label {
  font-family: var(--sans);
  font-size: 0.6rem;
  text-transform: uppercase;
  letter-spacing: 0.2em;
  color: var(--gold-dim);
  margin-bottom: 0.5rem;
}

.similar-ref-name {
  font-family: var(--serif);
  font-size: 1.3rem;
  font-weight: 400;
  color: var(--cream);
  margin-bottom: 0.25rem;
}

.similar-ref-meta {
  font-size: 0.72rem;
  color: var(--cream-dim);
  font-weight: 300;
  margin-bottom: 1rem;
}

.similar-clear {
  font-family: var(--sans);
  font-size: 0.58rem;
  text-transform: uppercase;
  letter-spacing: 0.12em;
  color: var(--cream-muted);
  background: none;
  border: 1px solid var(--border-light);
  border-radius: var(--radius);
  padding: 0.3rem 0.6rem;
  cursor: pointer;
  transition: all 0.2s;
  margin-top: 0.75rem;
}

.similar-clear:hover {
  color: var(--gold);
  border-color: var(--gold);
}

.catalog-loading {
  text-align: center;
  padding: 2rem 1rem;
  font-family: var(--serif);
  font-size: 0.85rem;
  font-style: italic;
  color: var(--cream-muted);
}

@keyframes pulse {
  0%, 100% { opacity: 0.4; }
  50% { opacity: 1; }
}

.catalog-loading span {
  animation: pulse 1.5s ease infinite;
}

/* ── Vector bar chart ── */
.vector-chart {
  display: flex;
  flex-direction: column;
  gap: 0.35rem;
  max-width: 320px;
  margin-top: 0.75rem;
}

.vector-row {
  display: flex;
  align-items: center;
  gap: 0.5rem;
}

.vector-label {
  font-family: var(--sans);
  font-size: 0.55rem;
  text-transform: uppercase;
  letter-spacing: 0.1em;
  color: var(--cream-muted);
  width: 52px;
  text-align: right;
  flex-shrink: 0;
}

.vector-track {
  flex: 1;
  height: 4px;
  background: var(--border-light);
  border-radius: 2px;
  overflow: hidden;
}

.vector-fill {
  height: 100%;
  border-radius: 2px;
  background: var(--gold);
  transition: width 0.4s ease;
}

.vector-val {
  font-family: var(--sans);
  font-size: 0.5rem;
  color: var(--cream-muted);
  width: 22px;
  flex-shrink: 0;
}

/* ── Empty state ── */
.empty-state {
  text-align: center;
  padding: 4rem 1rem;
}

.empty-state h2 {
  font-family: var(--serif);
  font-size: 1.4rem;
  font-weight: 400;
  color: var(--cream);
  margin-bottom: 0.5rem;
  font-style: italic;
}

.empty-state p {
  font-size: 0.75rem;
  color: var(--cream-muted);
  font-weight: 300;
  letter-spacing: 0.03em;
}

.example-queries {
  display: flex;
  flex-wrap: wrap;
  gap: 0.5rem;
  justify-content: center;
  margin-top: 2rem;
}

.example-chip {
  padding: 0.55rem 1rem;
  font-family: var(--serif);
  font-size: 0.78rem;
  font-style: italic;
  color: var(--cream-muted);
  background: transparent;
  border: 1px solid var(--border-light);
  cursor: pointer;
  transition: all 0.25s;
  border-radius: var(--radius);
}

.example-chip:hover {
  color: var(--gold);
  border-color: var(--gold);
}

/* ── Footer ── */
footer {
  text-align: center;
  padding: 2rem 1rem 3rem;
  border-top: 1px solid var(--border);
}

.footer-mark {
  font-family: var(--serif);
  font-size: 0.85rem;
  color: var(--cream-muted);
  letter-spacing: 0.04em;
}

.footer-mark .dot { color: var(--gold-dim); }

.footer-sub {
  font-size: 0.55rem;
  color: rgba(242,236,224,0.15);
  margin-top: 0.5rem;
  letter-spacing: 0.15em;
  text-transform: uppercase;
}

/* ── Responsive ── */
@media (min-width: 640px) {
  header { padding: 4rem 2rem 2.5rem; }
  .brand h1 { font-size: 3.6rem; }
  main { padding: 2rem 2rem 5rem; }
  .wine-card { padding: 1.75rem 0; }
  .wine-name { font-size: 1.25rem; }
}

@media (max-width: 400px) {
  header { padding: 2rem 1rem 1.5rem; }
  .brand h1 { font-size: 2.2rem; }
  #search { font-size: 0.9rem; padding: 0.85rem 1rem; }
  .chip { padding: 0.75rem 0.85rem; font-size: 0.6rem; }
  .wine-name { font-size: 1rem; }
}
</style>
</head>
<body>

<header>
  <button class="theme-toggle" id="themeToggle" aria-label="Toggle light/dark mode">
    <svg class="icon-moon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
      <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/>
    </svg>
    <svg class="icon-sun" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
      <circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/>
    </svg>
  </button>

  <svg class="legs-decoration" viewBox="0 0 200 300" fill="none" xmlns="http://www.w3.org/2000/svg">
    <path d="M60 0 C60 50, 30 100, 45 200 S70 280, 55 300" stroke="currentColor" stroke-width="1.5" fill="none" opacity="0.5"/>
    <path d="M100 0 C100 60, 80 120, 95 210 S115 270, 105 300" stroke="currentColor" stroke-width="1" fill="none" opacity="0.3"/>
    <path d="M140 0 C140 40, 160 110, 145 190 S130 260, 150 300" stroke="currentColor" stroke-width="1.5" fill="none" opacity="0.5"/>
  </svg>

  <div class="brand">
    <h1>wine<span class="dot">.</span>ai</h1>
    <div class="tagline">Taste Intelligence</div>
  </div>

  <div class="search-section">
    <input type="text" id="search" placeholder="smooth red, berry notes, not too dry" autocomplete="off" spellcheck="false" />
    <button class="search-clear" id="clearBtn">&times;</button>
  </div>

  <div class="stats-line" id="subtitle">371 wines &middot; 3 stores</div>
</header>

<div class="filters-wrap">
  <div class="filters" id="filters">
    <button class="chip" data-filter="colour:Red">Red</button>
    <button class="chip" data-filter="colour:White">White</button>
    <button class="chip" data-filter="colour:Rose">Ros&eacute;</button>
    <button class="chip" data-filter="subtype:sparkling">Sparkling</button>
    <button class="chip" data-filter="price:15">Under $15</button>
    <button class="chip" data-filter="price:25">Under $25</button>
    <button class="chip" data-filter="price:50">Under $50</button>
  </div>
</div>

<main id="main">
  <div class="results-header">
    <span class="results-count" id="resultsCount"></span>
    <button class="sort-btn" id="sortBtn">Best Match</button>
  </div>
  <div id="results"></div>
</main>

<footer>
  <div class="footer-mark">wine<span class="dot">.</span>ai</div>
  <div class="footer-sub">Baldwinsville, NY</div>
</footer>

<script>
// Theme toggle — runs before module to avoid flash
(function() {
  const saved = localStorage.getItem('wineai-theme');
  if (saved) document.documentElement.setAttribute('data-theme', saved);
})();
</script>
<script type="module">
import { stores } from './data/inventory.js';
import { parsePrompt, similarity, matchReason, distanceMiles, DIMENSIONS } from './data/lexicon.js';

// ── Theme toggle ──
const themeToggle = document.getElementById('themeToggle');
themeToggle.addEventListener('click', () => {
  const current = document.documentElement.getAttribute('data-theme');
  const next = current === 'light' ? 'dark' : 'light';
  if (next === 'dark') {
    document.documentElement.removeAttribute('data-theme');
  } else {
    document.documentElement.setAttribute('data-theme', next);
  }
  localStorage.setItem('wineai-theme', next === 'dark' ? '' : next);
});

const USER_LAT = 43.1587;
const USER_LNG = -76.3327;

// ── Preprocess ──
const allWines = [];
for (const store of stores) {
  const dist = distanceMiles(USER_LAT, USER_LNG, store.lat, store.lng);
  for (const wine of store.wines) {
    allWines.push({
      ...wine,
      storeId: store.id,
      storeName: store.name,
      storeAddress: store.address,
      storeDist: Math.round(dist * 10) / 10,
    });
  }
}

function normalizeKey(name) {
  return name.toLowerCase().replace(/[^a-z0-9]/g, '');
}

const wineGroups = new Map();
for (const w of allWines) {
  const key = normalizeKey(w.name);
  if (!wineGroups.has(key)) wineGroups.set(key, []);
  wineGroups.get(key).push(w);
}

for (const [, group] of wineGroups) {
  group.sort((a, b) => (a.price || 999) - (b.price || 999));
}

const uniqueWines = [];
const seen = new Set();
for (const w of allWines) {
  const key = normalizeKey(w.name);
  if (!seen.has(key)) {
    seen.add(key);
    uniqueWines.push(w);
  }
}

document.getElementById('subtitle').textContent =
  `${allWines.length} wines \u00B7 ${stores.length} stores`;

// ── State ──
let activeFilters = new Set();
let sortMode = 'match';
let currentResults = [];
let currentTarget = null;

// ── Placeholder cycling ──
const placeholders = [
  'smooth red, berry notes, not too dry',
  'crisp white for seafood',
  'bold cabernet under $30',
  'fruity Italian red',
  'easy-drinking pinot noir',
  'dry ros\u00e9, refreshing',
  'something like Barefoot Moscato but drier',
  'spicy shiraz from Australia',
  'buttery chardonnay',
  'I liked the Kim Crawford',
  'sweet moscato under $15',
  'full-bodied malbec',
];

let phIdx = 0;
const searchInput = document.getElementById('search');
const clearBtn = document.getElementById('clearBtn');

setInterval(() => {
  if (document.activeElement !== searchInput && !searchInput.value) {
    phIdx = (phIdx + 1) % placeholders.length;
    searchInput.placeholder = placeholders[phIdx];
  }
}, 3500);

// ── Event listeners ──
let debounceTimer = null;

searchInput.addEventListener('input', () => {
  clearBtn.classList.toggle('visible', searchInput.value.length > 0);
  clearTimeout(debounceTimer);
  debounceTimer = setTimeout(runSearch, 200);
});

searchInput.addEventListener('keydown', (e) => {
  if (e.key === 'Enter') { clearTimeout(debounceTimer); runSearch(); }
});

clearBtn.addEventListener('click', () => {
  searchInput.value = '';
  clearBtn.classList.remove('visible');
  similarMode = null;
  runSearch();
  searchInput.focus();
});

document.getElementById('filters').addEventListener('click', (e) => {
  const chip = e.target.closest('.chip');
  if (!chip) return;
  const f = chip.dataset.filter;
  if (activeFilters.has(f)) {
    activeFilters.delete(f);
    chip.classList.remove('active');
  } else {
    const type = f.split(':')[0];
    for (const af of [...activeFilters]) {
      if (af.startsWith(type + ':')) {
        activeFilters.delete(af);
        document.querySelector(`[data-filter="${af}"]`)?.classList.remove('active');
      }
    }
    activeFilters.add(f);
    chip.classList.add('active');
  }
  runSearch();
});

const sortBtn = document.getElementById('sortBtn');
const sortModes = ['match', 'price', 'name'];
const sortLabels = { match: 'Best Match', price: 'Price: Low', name: 'A \u2013 Z' };

sortBtn.addEventListener('click', () => {
  const idx = sortModes.indexOf(sortMode);
  sortMode = sortModes[(idx + 1) % sortModes.length];
  sortBtn.textContent = sortLabels[sortMode];
  renderResults(currentResults, currentTarget, similarMode);
});

document.addEventListener('click', (e) => {
  if (e.target.classList.contains('example-chip')) {
    searchInput.value = e.target.textContent;
    clearBtn.classList.add('visible');
    runSearch();
    window.scrollTo({ top: 0, behavior: 'smooth' });
  }
});

// ── Similar wine state ──
let similarMode = null; // null or { wine, vector, name }

// ── Find similar via button ──
function findSimilar(wineName) {
  const key = normalizeKey(wineName);
  const match = uniqueWines.find(w => normalizeKey(w.name) === key);
  if (!match || !match.vector) return;
  similarMode = { wine: match, vector: [...match.vector], name: match.name };
  searchInput.value = '';
  clearBtn.classList.remove('visible');
  runSearch();
  window.scrollTo({ top: 0, behavior: 'smooth' });
}

function clearSimilar() {
  similarMode = null;
  runSearch();
}

// Make findSimilar available to onclick handlers
window._findSimilar = findSimilar;
window._clearSimilar = clearSimilar;

// ── Natural language "similar to" detection ──
const SIMILAR_PATTERNS = [
  /something like (.+?)(?:\s+but\s+(.+))?$/i,
  /similar to (?:the )?(.+?)(?:\s+but\s+(.+))?$/i,
  /i liked (?:the )?(.+?)(?:\s+but\s+(.+))?$/i,
  /more like (?:the )?(.+?)(?:\s+but\s+(.+))?$/i,
  /another (.+?)(?:\s+but\s+(.+))?$/i,
  /wines? like (.+?)(?:\s+but\s+(.+))?$/i,
];

// Modifier keywords that adjust a reference vector
const MODIFIER_MAP = {
  'drier':       { sweetness: -0.25, acidity: 0.10 },
  'sweeter':     { sweetness: 0.25 },
  'lighter':     { body: -0.20, tannin: -0.15 },
  'heavier':     { body: 0.20, tannin: 0.15 },
  'bolder':      { body: 0.20, tannin: 0.20 },
  'smoother':    { tannin: -0.20, acidity: -0.10 },
  'more fruit':  { fruit: 0.20 },
  'less fruit':  { fruit: -0.20 },
  'fruitier':    { fruit: 0.20 },
  'more oaky':   { oak: 0.20 },
  'less oaky':   { oak: -0.20 },
  'oakier':      { oak: 0.20 },
  'more spicy':  { spice: 0.20 },
  'less spicy':  { spice: -0.20 },
  'spicier':     { spice: 0.20 },
  'more tannic':  { tannin: 0.20 },
  'less tannic':  { tannin: -0.20 },
  'crisper':     { acidity: 0.20 },
  'more acidic': { acidity: 0.20 },
  'less acidic': { acidity: -0.20 },
};

// ── Catalog (lazy-loaded for "similar to" search across 142K wines) ──
let catalogData = null;     // null = not loaded, array = loaded
let catalogLoading = false;

async function loadCatalog() {
  if (catalogData) return catalogData;
  if (catalogLoading) {
    // Wait for existing load
    while (catalogLoading) await new Promise(r => setTimeout(r, 50));
    return catalogData;
  }
  catalogLoading = true;
  try {
    const mod = await import('./data/catalog.js');
    // catalog is array of [name, grape, country, colour, [vector]]
    catalogData = mod.catalog;
    console.log(`Catalog loaded: ${catalogData.length} wines`);
  } catch (e) {
    console.warn('Failed to load catalog:', e);
    catalogData = [];
  }
  catalogLoading = false;
  return catalogData;
}

function fuzzyMatchLocal(query) {
  return fuzzyMatchInList(query, uniqueWines, w => w.name || '', w => w.brand || '');
}

function fuzzyMatchCatalog(query, catalog) {
  // Catalog entries are arrays: [name, grape, country, colour, [vector]]
  const result = fuzzyMatchInList(query, catalog, e => e[0], () => '');
  if (!result) return null;
  // Convert to wine-like object for display
  return {
    name: result[0],
    grape: result[1] || '',
    country: result[2] || '',
    colour: result[3] || '',
    vector: result[4],
    _fromCatalog: true,
  };
}

function fuzzyMatchInList(query, list, getName, getBrand) {
  const q = query.toLowerCase().trim();
  const qTokens = q.replace(/[^a-z0-9\s]/g, '').split(/\s+/).filter(Boolean);
  if (qTokens.length === 0) return null;

  let bestScore = 0;
  let bestItem = null;

  for (const item of list) {
    const name = getName(item).toLowerCase();
    // Exact substring match — strong signal
    if (name.includes(q)) {
      // Prefer shorter names (more specific match)
      const specificity = q.length / name.length;
      if (specificity > bestScore || !bestItem) {
        bestScore = Math.max(specificity, 0.8);
        bestItem = item;
      }
      continue;
    }
    // Token overlap
    const nTokens = name.replace(/[^a-z0-9\s]/g, '').split(/\s+/).filter(Boolean);
    const overlap = qTokens.filter(t => nTokens.some(n => n.includes(t) || t.includes(n))).length;
    const score = overlap / Math.max(qTokens.length, 1);
    const brand = getBrand(item).toLowerCase();
    const brandBoost = brand && q.includes(brand) ? 0.3 : 0;
    const total = score + brandBoost;
    if (total > bestScore) {
      bestScore = total;
      bestItem = item;
    }
  }

  return bestScore >= 0.5 ? bestItem : null;
}

function applyModifiers(vector, modifierText) {
  if (!modifierText) return vector;
  const v = [...vector];
  const lower = modifierText.toLowerCase();
  const dimIdx = { tannin: 0, acidity: 1, sweetness: 2, body: 3, fruit: 4, oak: 5, spice: 6 };
  for (const [phrase, adjustments] of Object.entries(MODIFIER_MAP)) {
    if (lower.includes(phrase)) {
      for (const [dim, delta] of Object.entries(adjustments)) {
        v[dimIdx[dim]] = Math.max(0, Math.min(1, v[dimIdx[dim]] + delta));
      }
    }
  }
  return v;
}

function parseSimilarQuery(query) {
  for (const re of SIMILAR_PATTERNS) {
    const m = query.match(re);
    if (m) {
      return { wineName: m[1].trim(), modifiers: m[2] ? m[2].trim() : null };
    }
  }
  return null;
}

async function detectSimilarQuery(query) {
  const parsed = parseSimilarQuery(query);
  if (!parsed) return null;

  const { wineName, modifiers } = parsed;

  // 1. Try local inventory first (instant)
  const localMatch = fuzzyMatchLocal(wineName);
  if (localMatch && localMatch.vector) {
    const vec = applyModifiers([...localMatch.vector], modifiers);
    return { wine: localMatch, vector: vec, name: localMatch.name, modifiers };
  }

  // 2. Search full catalog (lazy-load 142K wines)
  const catalog = await loadCatalog();
  if (catalog && catalog.length > 0) {
    const catMatch = fuzzyMatchCatalog(wineName, catalog);
    if (catMatch && catMatch.vector) {
      const vec = applyModifiers([...catMatch.vector], modifiers);
      return { wine: catMatch, vector: vec, name: catMatch.name, modifiers };
    }
  }

  return null;
}

// ── Similar-mode match reason (describes shared profile, not the reference) ──
function similarReason(refVec, wineVec) {
  const labels = ['tannin', 'acidity', 'sweetness', 'body', 'fruit', 'oak', 'spice'];
  const descriptors = {
    tannin:    { high: 'bold tannins', low: 'soft tannins', mid: 'moderate tannins' },
    acidity:   { high: 'bright acidity', low: 'mellow', mid: 'balanced acidity' },
    sweetness: { high: 'sweet', low: 'dry', mid: 'off-dry' },
    body:      { high: 'full-bodied', low: 'light-bodied', mid: 'medium-bodied' },
    fruit:     { high: 'fruit-forward', low: 'earthy', mid: 'moderate fruit' },
    oak:       { high: 'oaky', low: 'unoaked', mid: 'lightly oaked' },
    spice:     { high: 'spicy', low: 'mild', mid: 'hint of spice' },
  };

  // Find dimensions where BOTH wines agree (both high, both low, etc.)
  const shared = [];
  for (let i = 0; i < 7; i++) {
    const rv = refVec[i] || 0.5;
    const wv = wineVec[i] || 0.5;
    const diff = Math.abs(rv - wv);
    if (diff < 0.2) {
      const avg = (rv + wv) / 2;
      const level = avg >= 0.65 ? 'high' : avg <= 0.3 ? 'low' : 'mid';
      shared.push({ dim: labels[i], desc: descriptors[labels[i]][level], diff, avg });
    }
  }

  shared.sort((a, b) => {
    // Prefer extreme (more interesting) shared traits
    const aExtreme = Math.abs(a.avg - 0.5);
    const bExtreme = Math.abs(b.avg - 0.5);
    return bExtreme - aExtreme;
  });

  const top = shared.slice(0, 3).map(s => s.desc);
  const unique = [...new Set(top)];
  return unique.length > 0 ? 'Similar profile \u2014 ' + unique.join(', ') : 'Similar overall profile';
}

// ── Search logic ──
let searchSeq = 0; // Prevent stale async results from overwriting newer searches

async function runSearch() {
  const seq = ++searchSeq;
  const query = searchInput.value.trim();
  let pool = uniqueWines;

  for (const f of activeFilters) {
    const [type, val] = f.split(':');
    if (type === 'colour') pool = pool.filter(w => (w.colour || '').toLowerCase() === val.toLowerCase());
    else if (type === 'subtype') pool = pool.filter(w => (w.subtype || '').toLowerCase() === val.toLowerCase());
    else if (type === 'price') { const max = parseFloat(val); pool = pool.filter(w => w.price && w.price <= max); }
  }

  // Check for similar-wine mode (button-triggered)
  if (similarMode) {
    currentTarget = similarMode.vector;
    const refKey = normalizeKey(similarMode.name);
    currentResults = pool
      .filter(w => normalizeKey(w.name) !== refKey)
      .map(w => {
        const vec = w.vector || [0.5,0.5,0.5,0.5,0.5,0.5,0.5];
        const sim = similarity(similarMode.vector, vec);
        return { ...w, score: sim, matchPct: Math.round(sim * 100), reason: similarReason(similarMode.vector, vec) };
      });
    currentResults.sort((a, b) => b.score - a.score);
    renderResults(currentResults, similarMode.vector, similarMode);
    return;
  }

  if (!query) {
    currentTarget = null;
    currentResults = pool.map(w => ({ ...w, score: defaultScore(w), matchPct: null, reason: '' }));
    currentResults.sort((a, b) => b.score - a.score);
    renderResults(currentResults, null, null);
    return;
  }

  // Check for "similar to" natural language (may trigger async catalog load)
  if (parseSimilarQuery(query)) {
    // Show loading state if catalog hasn't loaded yet
    if (!catalogData) {
      document.getElementById('results').innerHTML =
        '<div class="catalog-loading"><span>Searching 142,000 wines\u2026</span></div>';
      document.getElementById('resultsCount').textContent = '';
    }
    const similarDetected = await detectSimilarQuery(query);
    if (seq !== searchSeq) return; // Stale — user typed something else
    if (similarDetected) {
      const refKey = normalizeKey(similarDetected.name);
      currentTarget = similarDetected.vector;
      currentResults = pool
        .filter(w => normalizeKey(w.name) !== refKey)
        .map(w => {
          const vec = w.vector || [0.5,0.5,0.5,0.5,0.5,0.5,0.5];
          const sim = similarity(similarDetected.vector, vec);
          return { ...w, score: sim, matchPct: Math.round(sim * 100), reason: similarReason(similarDetected.vector, vec) };
        });
      currentResults.sort((a, b) => b.score - a.score);
      renderResults(currentResults, similarDetected.vector, similarDetected);
      return;
    }
  }

  const { target, filters } = parsePrompt(query);
  currentTarget = target;

  if (filters.colour) pool = pool.filter(w => (w.colour || '').toLowerCase() === filters.colour.toLowerCase());
  if (filters.grape) pool = pool.filter(w => (w.grape || '').toLowerCase().includes(filters.grape));
  if (filters.country) pool = pool.filter(w => (w.country || '').toLowerCase().includes(filters.country.toLowerCase()));
  if (filters.region) pool = pool.filter(w => (w.region || '').toLowerCase().includes(filters.region.toLowerCase()));
  if (filters.priceMax) pool = pool.filter(w => !w.price || w.price <= filters.priceMax);
  if (filters.priceMin) pool = pool.filter(w => !w.price || w.price >= filters.priceMin);

  currentResults = pool.map(w => {
    const vec = w.vector || [0.5,0.5,0.5,0.5,0.5,0.5,0.5];
    const sim = similarity(target, vec);
    return { ...w, score: sim, matchPct: Math.round(sim * 100), reason: matchReason(target, vec) };
  });

  currentResults.sort((a, b) => b.score - a.score);
  renderResults(currentResults, target, null);
}

function defaultScore(w) {
  let s = 0;
  if (w.rating && w.rating > 0) s += w.rating * 0.1;
  if (w.rating_count && w.rating_count > 0) s += Math.min(w.rating_count / 100, 0.3);
  if (w.match_type === 'exact') s += 0.3;
  else if (w.match_type === 'fuzzy') s += 0.2;
  if (w.description && w.description.length > 50) s += 0.1;
  let h = 0;
  for (let i = 0; i < (w.name || '').length; i++) h = ((h << 5) - h + w.name.charCodeAt(i)) | 0;
  s += (Math.abs(h) % 100) / 1000;
  return s;
}

// ── Vector bar chart HTML ──
function renderVectorChart(vector) {
  const dims = ['tannin', 'acidity', 'sweetness', 'body', 'fruit', 'oak', 'spice'];
  let html = '<div class="vector-chart">';
  for (let i = 0; i < 7; i++) {
    const val = vector[i] || 0;
    const pct = Math.round(val * 100);
    html += `<div class="vector-row">
      <span class="vector-label">${dims[i]}</span>
      <div class="vector-track"><div class="vector-fill" style="width:${pct}%"></div></div>
      <span class="vector-val">${val.toFixed(2)}</span>
    </div>`;
  }
  html += '</div>';
  return html;
}

// ── Render ──
function renderResults(results, target, similarRef) {
  const container = document.getElementById('results');
  const countEl = document.getElementById('resultsCount');

  let sorted = [...results];
  if (sortMode === 'price') sorted.sort((a, b) => (a.price || 999) - (b.price || 999));
  else if (sortMode === 'name') sorted.sort((a, b) => (a.name || '').localeCompare(b.name || ''));

  const display = sorted.slice(0, 50);
  countEl.textContent = `${results.length} wine${results.length !== 1 ? 's' : ''}`;

  if (results.length === 0 && searchInput.value.trim()) {
    container.innerHTML = `
      <div class="empty-state">
        <h2>Nothing found</h2>
        <p>Try different terms or remove a filter</p>
      </div>`;
    return;
  }

  if (results.length === 0 && !similarRef) {
    container.innerHTML = `
      <div class="empty-state">
        <h2>What are you in the mood for?</h2>
        <p>Describe a taste, a grape, a price, a feeling</p>
        <div class="example-queries">
          <span class="example-chip">smooth red under $20</span>
          <span class="example-chip">crisp white for seafood</span>
          <span class="example-chip">bold cabernet</span>
          <span class="example-chip">fruity pinot noir</span>
          <span class="example-chip">dry ros\u00e9</span>
          <span class="example-chip">sweet moscato</span>
          <span class="example-chip">something like Barefoot Moscato</span>
          <span class="example-chip">I liked the Kim Crawford</span>
        </div>
      </div>`;
    countEl.textContent = '';
    return;
  }

  let html = '';

  // Similar-mode reference card
  if (similarRef) {
    const ref = similarRef.wine;
    const refMeta = [];
    if (ref.grape) refMeta.push(capitalize(ref.grape));
    if (ref.region) refMeta.push(ref.region);
    if (ref.country && ref.country !== ref.region) refMeta.push(ref.country);
    if (ref.colour) refMeta.push(ref.colour);
    const isFromCatalog = ref._fromCatalog;
    const localNote = isFromCatalog ? ' <span style="opacity:0.5;font-style:italic">\u2014 not sold locally</span>' : '';

    html += `
    <div class="similar-header">
      <div class="similar-label">Similar to</div>
      <div class="similar-ref-name">${esc(ref.name)}</div>
      <div class="similar-ref-meta">${refMeta.join(' / ')}${ref.price ? ` \u2014 $${ref.price.toFixed(2)}` : ''}${localNote}</div>
      ${renderVectorChart(similarRef.vector)}
      <button class="similar-clear" onclick="window._clearSimilar()">Clear &times;</button>
    </div>`;
  }

  for (const w of display) {
    const key = normalizeKey(w.name);
    const group = wineGroups.get(key) || [w];
    const cheapest = group[0];
    const otherStores = group.filter(g => g.storeId !== cheapest.storeId);

    const wine = w;
    const metaParts = [];
    if (wine.grape) metaParts.push(capitalize(wine.grape));
    if (wine.region) metaParts.push(wine.region);
    if (wine.country && wine.country !== wine.region) metaParts.push(wine.country);

    let desc = wine.description || '';
    if (desc.startsWith('Get ') && desc.includes(' from ')) desc = '';
    const hasNotes = desc.length > 20;

    const showMatch = wine.matchPct !== null && wine.matchPct !== undefined;

    const alsoAt = otherStores.map(o => {
      const short = o.storeName.replace("'s Liquors", "'s").replace(" Discount Liquors", "'s");
      return short + (o.price ? ` \u2014 $${o.price.toFixed(2)}` : '');
    });

    // Escape wine name for onclick attribute
    const nameForJs = wine.name.replace(/\\/g, '\\\\').replace(/'/g, "\\'");

    html += `
    <div class="wine-card">
      <div class="card-top">
        <div class="card-info">
          <div class="wine-name">${esc(wine.name)}</div>
          <div class="wine-meta">
            ${metaParts.map(p => `<span>${esc(p)}</span>`).join('<span class="meta-sep">/</span>')}
          </div>
        </div>
        ${showMatch ? `
        <div class="match-badge">
          <span class="match-pct">${wine.matchPct}</span>
          <span class="match-label">match</span>
        </div>` : ''}
      </div>
      <div class="card-details">
        ${wine.price ? `<span class="detail-item price">$${wine.price.toFixed(2)}</span>` : ''}
        <span class="detail-item store">${shortStore(wine.storeName)} \u00B7 ${wine.storeDist} mi</span>
        ${wine.colour ? `<span class="detail-item">${wine.colour}</span>` : ''}
        ${alsoAt.map(s => `<span class="detail-item also">Also at ${esc(s)}</span>`).join('')}
        ${wine.vector ? `<button class="btn-similar" onclick="window._findSimilar('${nameForJs}')">Find similar</button>` : ''}
      </div>
      ${showMatch && wine.reason ? `<div class="card-reason">${esc(wine.reason)}</div>` : ''}
      ${hasNotes ? `
        <button class="notes-toggle" onclick="this.nextElementSibling.classList.toggle('open'); this.textContent = this.nextElementSibling.classList.contains('open') ? 'Hide Notes' : 'Tasting Notes';">Tasting Notes</button>
        <div class="card-notes">${esc(desc)}</div>
      ` : ''}
    </div>`;
  }

  container.innerHTML = html;
}

function capitalize(s) { return s ? s.charAt(0).toUpperCase() + s.slice(1) : ''; }

function shortStore(name) {
  return name
    .replace("'s Liquors", "'s")
    .replace(" Discount Liquors", "'s")
    .replace("Liquor Express", "Liq. Express");
}

function esc(s) {
  const d = document.createElement('div');
  d.textContent = s || '';
  return d.innerHTML;
}

runSearch();
</script>

</body>
</html>
